@using lets_do_a_website.Data.Entities;
@model Tracker
@{ViewData["Title"] = "50 Ways to Die";}

<div class="container navbar navbar-expand-sm">
    <div class="navbar-brand">You have died</div>
    <div class="navbar-brand" id="deathCount"></div>
    <div class="navbar-brand">/ 50 ways</div>
    <div class="navbar-brand" id="encourage"></div>
</div>
<div id="recon-warning" class="p-3 mb-2 alert alert-danger d-none" data-toggle="collapse">Connection to server lost. Attempting to reconnect, overlay will not update! Changes are not being saved!</div>

<br />

<div id="Clicksters" class="container gap-2">
    <div class="bg-light">

            <div >Enemies</div>

            @foreach (var d in Model.DeathWays!.Values)
            {
                var cl = "deathPic2";
                if (d.Active) cl="deathPic";
                if (d.Category != "Enemy") continue;
                <img id="img-@d.Id" src="~/img/50wtd/@(d.Id).png" class="@cl" onclick="toggleDeath('@Model.Id', @d.Id)" title="@d.Name">
            }
    </div>
    <br />
    <div class="bg-light">
        <div >3DW</div>
            @foreach (var d in Model.DeathWays.Values)
            {
                var cl = "deathPic2";
                if (d.Active) cl="deathPic";
                if (d.Category != "3DW") continue;
            <img id="img-@d.Id" src="~/img/50wtd/@(d.Id).png" class="@cl" onclick="toggleDeath('@Model.Id', @d.Id)" title="@d.Name">
            }
    </div>
    <br />
    <div class="bg-light">
        <div>Gizmo</div>
            @foreach (var d in Model.DeathWays.Values)
            {
                var cl = "deathPic2";
                if (d.Active) cl="deathPic";
                if (d.Category != "Gizmo") continue;
            <img id="img-@d.Id" src="~/img/50wtd/@(d.Id).png" class="@cl" onclick="toggleDeath('@Model.Id', @d.Id)" title="@d.Name">
            }
    </div>
    <br />
    <div class="bg-light">
           <div >Etc</div>
            @foreach (var d in Model.DeathWays.Values)
            {
                var cl = "deathPic2";
                if (d.Active) cl="deathPic";
                @if (d.Category != "Etc") continue;
            <img id="img-@d.Id" src="~/img/50wtd/@(d.Id).png" class="@cl" onclick="toggleDeath('@Model.Id', @d.Id)" title="@d.Name">

            }
    </div>
</div>



<br />
<br />
<br />
<a id="reset" class="btn btn-danger" asp-action="Reset" asp-route-id="@Model.Id">RESET Run</a>

<br />
<br />
@{
    var overlay1 = Url.Action("Overlay","WTD", new { id = Model.Id},"https");
}
Overlay options:
<br />

<div id="page-bottom-stuff" class="container">
<div class="row">
<div id="Overlays" class="col-5">

Standard horizontal overlay
<div class="input-group">
    <input type="text" class="form-control" value="@overlay1" id="overlay-1">
    <button class="btn btn-outline-dark" type="button" id="copy-button" title="Copy to Clipboard" onclick="copyOverlay(1)">Copy</button>
    <a class="btn btn-outline-dark btn-lg " asp-action="Overlay" asp-route-id="@Model.Id">Go</a>
</div>
<br />

Vertical side-panel overlay
<div class="input-group">
    <input type="text" class="form-control" value="@overlay1" id="copy-input">
    <button class="btn btn-outline-dark  btn-secondary" type="button" id="copy-button" title="Copy to Clipboard" onclick="copyOverlay(2)">Copy</button>
    <a class="btn btn-outline-dark btn-lg  btn-secondary" asp-action="Overlay" asp-route-id="@Model.Id">Go</a>
</div>
<br />

Monopoly style overlay
<div class="input-group">
    <input type="text" class="form-control" value="@overlay1" id="copy-input">
    <button class="btn btn-outline-dark btn-secondary" type="button" id="copy-button" title="Copy to Clipboard" onclick="copyOverlay(3)">Copy</button>
    <a class="btn btn-outline-dark btn-lg  btn-secondary" asp-action="Overlay" asp-route-id="@Model.Id">Go</a>
</div>
</div>
<div class="col-1"></div>
<div id="rules" class="col-6">
    <p>Goal:</p>
    <ul class="list-group">
        <li class="list-item">Die in 50 different ways playing levels from Endless Expert difficulty. There are more than 50 ways listed (because some are very rare), when you reach 50 you win!</li>
    </ul>
    <br />
    <p>Rules:</p>
            <ul class="list-group">
                <li class="list-item">You can only die to 1 thing at a time. If you're not sure what killed you, don't count anything. If it fills multiple categories, pick 1</li>
                <li class="list-item">For ways that don't kill mario (softlock, losing clear con, killing yoshi), you must die/restart level to count it</li>
        <li class="list-item">Skipping levels is allowed.</li>
        <li class="list-item">Getting a Game Over is allowed, just start a new one in game</li>

        <li class="list-item">Projectiles (wrenches, hammers, spikeballs, koopas, etc) count as the enemy who threw it if they hit you midair. If the item is still alive after landing then it counts as that enemy AFTER it lands            </li>
        <li class="list-item">All goomba/galoomba/goombuds are the same thing, unless they have a boot</li>
        <li class="list-item">All boot types are the same thing</li>
        <li class="list-item">All koopakids are the same thing</li>
        <li class="list-item">Etc, if you died to something not directly pictured, there should be something it obviously counts as</li>
        <li class="list-item">Key death is any death while holding a key, not just redcoins after a CP</li>
        <li class="list-item">Yoshi death is you killing yoshi, not you dieing while on yoshi</li>
        <li class="list-item">Clear con is losing a clear con which you cannot re-qualify for (Jumping, Damage, etc?)</li>
        <li class="list-item">Kaizo block must *cause* the death, you shouldn't have to try to die after hiting it. It does not need to be blind (you can discover it and not die, then die to it in the next life)</li>

    </ul>
    <br />
    Multi-player match rules
    <ul class="list-group">
        <li class="list-item">All of the above + ways to "undo" deaths, add them back to your opponents</li>
        <li class="list-item">Idk I'll think of them once I add the match functionality, ideas include</li>
        <li class="list-item">Gift subs / channel point redemptions to add back a death </li>
        <li class="list-item">Getting a game over adds back a death </li>
    </ul>

</div>
</div>

</div>



@section Scripts {
    <script type="text/javascript">

        function copyOverlay(i) {
            var ele = document.getElementById("overlay-"+i);
            ele.select();
            ele.setSelectionRange(0,9999);
            navigator.clipboard.writeText(ele.value);
        }

        function recalc() {
            var deaths = document.getElementById("Clicksters").getElementsByClassName("deathPic2").length
            document.getElementById("deathCount").innerText = deaths;
            if (deaths > 25)
                document.getElementById("encourage").innerText = "Good job!";
            if(deaths>49)
                document.getElementById("encourage").innerText = "You won!";

        }

        function toggleDeath(t,i) {

            const ele = document.getElementById("img-" + i);
            if (ele.classList.contains("deathPic2")) {
                //undo death
                ele.classList.remove("deathPic2");
                ele.classList.add("deathPic");

                conn.invoke("NotifyUndo", {
                    trackerId: t,
                    deathId: parseInt(i)
                });


            } else {
                //do death
                ele.classList.remove("deathPic");
                ele.classList.add("deathPic2");
                conn.invoke("NotifyDeath", {
                    trackerId: t,
                    deathId: parseInt(i)
                });
            };

            recalc();
        }

        function sendRefresh() {
            conn.invoke("NotifyRefresh", { trackerId: "@Model.Id", deathId: parseInt(0) });
        }

        function hideWarning() {
            herok
        }
        function showWarning() {
            let ele = document.getElementById("recon-warning");
        }


        function initializeSignalRConnection (t) {
            conn =  new signalR.HubConnectionBuilder()
                .withUrl("/trackerhub?tracker=" + t)
                .withAutomaticReconnect()
                .build();

  
    
            try {
               conn.start();
            } catch (err) {
                console.log(err);
            }

            conn.onreconnecting((error) => {
                $('#recon-warning').removeClass("d-none");
            });
            conn.onreconnected((error) => {
                $('#recon-warning').addClass("d-none");

            });

            return conn;
        }


        //On page load
        recalc();
        var conn = 0;
        initializeSignalRConnection("@Model.Id");

        //console is telling me conn.start isn't asynch even though the doc says it is so whatever we will hack it.
        function delay(time) {
            return new Promise(resolve => setTimeout(resolve, time));
        }

        delay(500).then(() => sendRefresh());
        

    </script>
}
    